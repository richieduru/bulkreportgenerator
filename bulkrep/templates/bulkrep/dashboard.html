{% extends 'bulkrep/base.html' %} {% load static %} {% block title %} Dashboard
{% endblock %} {% block extra_css %}
<style>
  .dashboard-container {
    padding: 20px;
    background-color: #f8f9fa;
    min-height: 100vh;
  }

  .dashboard-header {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  .metric-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
  }

  .metric-card:hover {
    transform: translateY(-5px);
  }

  .metric-card h3 {
    font-size: 1.8rem;
    font-weight: bold;
    margin-bottom: 8px;
  }

  .metric-card.top-subscriber h3 {
    font-size: 1.4rem;
  }

  .metric-card p {
    font-size: 0.85rem;
    margin: 0;
    opacity: 0.9;
    line-height: 1.2;
  }

  .chart-container {
    background: white;
    border-radius: 15px;
    padding: 25px 25px 40px 25px; /* Increased bottom padding for x-axis labels */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    margin-bottom: 35px; /* Increased margin to prevent overlap */
    height: 450px; /* Slightly increased height */
    overflow: hidden; /* Ensure content stays within bounds */
    position: relative; /* For proper positioning */
  }

  .chart-container canvas {
    max-height: 350px; /* Constrain canvas height to leave room for labels */
    width: 100% !important;
    height: auto !important;
  }

  .chart-container h5 {
    color: #333;
    margin-bottom: 25px; /* Increased spacing */
    font-weight: 600;
    padding-bottom: 10px;
    border-bottom: 2px solid #f8f9fa; /* Visual separation */
  }

  .dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 40px;
    border-radius: 15px;
    margin-bottom: 30px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  .dashboard-header h1 {
    margin: 0;
    font-size: 2.8rem;
    font-weight: 300;
  }

  .dashboard-header p {
    margin: 15px 0 0 0;
    font-size: 1.2rem;
    opacity: 0.9;
  }

  .controls-section {
    background: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  .loading-overlay {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: auto;
    height: auto;
    padding: 20px 30px;
    background: linear-gradient(
      135deg,
      rgba(102, 126, 234, 0.35) 0%,
      rgba(118, 75, 162, 0.35) 100%
    );
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    font-size: 1rem;
    color: #667eea;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    backdrop-filter: blur(5px);
  }

  .loading-overlay.hidden {
    display: none;
  }

  .btn-refresh {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    transition: all 0.3s ease;
  }

  .btn-refresh:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    color: white;
  }

  .btn-refresh:disabled {
    background: #e9ecef;
    color: #6c757d;
    cursor: not-allowed;
    box-shadow: none;
  }

  .btn-outline-secondary {
    background: transparent;
    color: #6c757d;
    border: 1px solid #dee2e6;
    padding: 10px 20px;
    border-radius: 8px;
    transition: all 0.3s ease;
  }

  .btn-outline-secondary:hover:not(:disabled) {
    background: #f8f9fa;
    border-color: #adb5bd;
    color: #495057;
  }

  .time-range-select {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    padding: 10px 15px;
  }

  .time-range-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
  }

  @media (max-width: 768px) {
    .dashboard-container {
      padding: 10px;
    }

    .dashboard-header {
      padding: 20px;
    }

    .dashboard-header h1 {
      font-size: 2.2rem;
    }

    .chart-container {
      height: 350px;
      padding: 20px 15px 35px 15px;
      margin-bottom: 25px;
    }

    .chart-container canvas {
      max-height: 250px;
    }

    .metric-card {
      padding: 20px;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="loading-overlay" id="loadingOverlay">
  <div class="text-center">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div class="mt-2">Loading dashboard data...</div>
  </div>
</div>

<div class="dashboard-container">
  <div class="dashboard-header">
    <h1>{{ title }}</h1>
    <p>Real-time analytics and insights for subscriber usage patterns</p>
  </div>

  <div class="controls-section">
    <div class="row align-items-center">
      <div class="col-md-8">
        <div class="d-flex gap-3 align-items-center flex-wrap">
          <label class="form-label mb-0 fw-bold">Date Range:</label>

          <select id="datePreset" class="form-select" style="width: 200px">
            <option value="custom">Custom Range</option>
            <option value="alltime">All Time</option>
          </select>

          <div class="d-flex gap-2 align-items-center" id="customDateInputs">
            <div class="input-group" style="width: 150px">
              <input type="date" id="startDate" class="form-control" />
              <span class="input-group-text"
                ><i class="fas fa-calendar"></i
              ></span>
            </div>
            <span class="text-muted">to</span>
            <div class="input-group" style="width: 150px">
              <input type="date" id="endDate" class="form-control" />
              <span class="input-group-text"
                ><i class="fas fa-calendar"></i
              ></span>
            </div>
          </div>

          <button id="loadDashboardBtn" class="btn btn-success">
            <i class="fas fa-play me-1"></i> Load Dashboard
          </button>
          <button id="applyBtn" class="btn btn-refresh" disabled>
            <i class="fas fa-check me-1"></i> Apply Changes
          </button>
          <button id="refreshBtn" class="btn btn-outline-secondary" style="display: none;">
            <i class="fas fa-sync-alt me-1"></i> Refresh
          </button>
        </div>

        <div class="mt-2">
          <small class="text-info">
            <i class="fas fa-info-circle me-1"></i>
            Showing data from <span id="currentDateRange">-</span>
          </small>
        </div>
      </div>
      <div class="col-md-4 text-end">
        <small class="text-muted"
          >Last updated: <span id="lastUpdated">-</span></small
        >
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-12">
      <div class="controls-section">
        <div class="row align-items-center">
          <div class="col-md-6">
            <div class="d-flex gap-3 align-items-center">
              <div>
                <label for="globalSubscriberFilter" class="form-label mb-1"
                  >Filter by Subscriber:</label
                >
                <div class="d-flex gap-2 align-items-end">
                  <select id="globalSubscriberFilter" class="form-select">
                    <option value="all">All Subscribers</option>
                  </select>
                  <button id="applySubscriberFilterBtn" class="btn btn-primary">
                    Apply
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6 text-end">
            <button id="resetFiltersBtn" class="btn btn-outline-secondary">
              <i class="fas fa-undo me-1"></i> Reset Filters
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="metric-card">
        <h3 id="totalSubscribers">-</h3>
        <p><i class="fas fa-users me-1"></i>Total Subscribers</p>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="metric-card">
        <h3 id="totalUsage">-</h3>
        <p><i class="fas fa-chart-bar me-1"></i>Total Usage Entries</p>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="metric-card">
        <h3 id="totalRevenue">-</h3>
        <p><i class="fas fa-naira-sign me-1"></i>Total Revenue</p>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="metric-card top-subscriber">
        <h3 id="topSubscriber">-</h3>
        <p><i class="fas fa-crown me-1"></i>Top Subscriber</p>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="metric-card">
        <h3 id="retentionRate">-</h3>
        <p><i class="fas fa-heart me-1"></i>Retention Rate</p>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="metric-card top-subscriber">
        <h3 id="highestProductByTransaction">-</h3>
        <p>
          <i class="fas fa-shopping-cart me-1"></i>Highest Product by
          Transaction
        </p>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="metric-card">
        <h3 id="highestProductByRevenue">-</h3>
        <p>
          <i class="fas fa-dollar-sign me-1"></i>Highest Product by Revenue
        </p>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="metric-card" id="dailyComparisonCard">
        <h3>
          <span id="yesterdayUsage">-</span>
          <small style="font-size: 1rem">yesterday</small>
          <span style="font-size: 1.2rem; margin: 0 8px">/</span>
          <span id="prevMonthSameDayUsage">-</span>
          <small style="font-size: 1rem">last month</small>
        </h3>
        <p>
          <i class="fas fa-calendar-day me-1"></i>
          <span id="dailyComparisonLabel"
            >Yesterday's Usage vs. Same Day Last Month</span
          >
        </p>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-lg-8">
      <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center">
          <h5><i class="fas fa-chart-line me-2"></i>Usage Trends Over Time</h5>
          <div class="d-flex gap-2">
            <select
              id="usageTrendsTimeFilter"
              class="form-select form-select-sm"
              style="width: 150px"
            >
              <option value="7">Last 7 days</option>
              <option value="30" selected>Last 30 days</option>
              <option value="90">Last 90 days</option>
              <option value="365">Last year</option>
            </select>
          </div>
        </div>
        <canvas id="usageTrendsChart"></canvas>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center">
          <h5><i class="fas fa-trophy me-2"></i>Top Products</h5>
          <div class="d-flex gap-2">
            <select
              id="topProductsFilter"
              class="form-select form-select-sm"
              style="width: 120px"
            >
              <option value="all">All Products</option>
            </select>
          </div>
        </div>
        <canvas id="topProductsChart"></canvas>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-lg-6">
      <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center">
          <h5><i class="fas fa-calendar-alt me-2"></i>3-Month Rolling Usage</h5>
          <div class="d-flex gap-2">
            <button
              id="load3MonthBtn"
              class="btn btn-primary btn-sm"
              onclick="loadThreeMonthData()"
            >
              <i class="fas fa-chart-line me-1"></i>Load 3-Month View
            </button>
            <button
              id="refresh3MonthBtn"
              class="btn btn-outline-secondary btn-sm"
              onclick="refreshThreeMonthData()"
              style="display: none;"
              title="Refresh 3-Month Data"
            >
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
        </div>
        <div id="threeMonthChartContainer" style="display: none">
          <canvas id="threeMonthUsageChart"></canvas>
        </div>
        <div id="threeMonthPlaceholder" class="text-center text-muted py-5">
          <i class="fas fa-chart-line fa-3x"></i>
          <p>
            Click "Load 3-Month View" to see the 3-month rolling usage chart
          </p>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center">
          <h5>
            <i class="fas fa-user-friends me-2"></i>Top Subscribers by Usage
          </h5>
          <div class="d-flex gap-2">
            <select
              id="topSubscribersFilter"
              class="form-select form-select-sm"
              style="width: 140px"
            >
              <option value="all">All Subscribers</option>
            </select>
          </div>
        </div>
        <canvas id="topSubscribersChart"></canvas>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-lg-6">
      <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center">
          <h5><i class="fas fa-user-plus me-2"></i>New Subscribers Trend</h5>
          <div class="d-flex gap-2 align-items-center">
            <select
              id="newSubscribersTimeFilter"
              class="form-select form-select-sm"
              style="width: 150px"
            >
              <option value="7">Last 7 days</option>
              <option value="30" selected>Last 30 days</option>
              <option value="90">Last 90 days</option>
              <option value="180">Last 6 months</option>
              <option value="365">Last year</option>
              <option value="custom">Custom Range</option>
            </select>
            <button
              id="downloadNewSubscribersBtn"
              class="btn btn-outline-secondary btn-sm"
              title="Download CSV"
              style="border: none; background: none; color: #6c757d"
            >
              <i class="fas fa-download"></i>
            </button>
          </div>
        </div>
        
        <div id="newSubscribersDateRange" class="mt-2" style="display: none;">
          <div class="d-flex gap-2 align-items-center flex-wrap">
            <label class="form-label mb-0 me-1" style="font-size: 0.875rem"
              >Date range:</label
            >
            <input
              type="date"
              id="newSubscribersStartDate"
              class="form-control form-control-sm"
              style="width: 130px"
            />
            <span class="text-muted">to</span>
            <input
              type="date"
              id="newSubscribersEndDate"
              class="form-control form-control-sm"
              style="width: 130px"
            />
            <button
              id="applyNewSubscribersDateRange"
              class="btn btn-primary btn-sm"
            >
              Apply
            </button>
          </div>
          <div id="appliedNewSubscribersDateRange" class="mt-2" style="display: none;">
            <small class="text-muted">
              <i class="fas fa-calendar-alt me-1"></i>
              Showing data for: <span id="appliedDateRangeText"></span>
            </small>
          </div>
        </div>
        <canvas id="newSubscribersChart"></canvas>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center">
          <h5><i class="fas fa-user-times me-2"></i>Churn Analysis</h5>
          <button
            id="downloadChurnedBtn"
            class="btn btn-outline-secondary btn-sm"
            title="Download CSV"
            style="border: none; background: none; color: #6c757d"
          >
            <i class="fas fa-download"></i>
          </button>
        </div>

        <div class="">
          <div class="d-flex gap-2 align-items-center flex-wrap">
            <label class="form-label mb-0 me-1" style="font-size: 0.875rem"
              >Date range:</label
            >
            <input
              type="date"
              id="churnStartDate"
              class="form-control form-control-sm"
              style="width: 130px"
            />
            <span class="mx-1">to</span>
            <input
              type="date"
              id="churnEndDate"
              class="form-control form-control-sm"
              style="width: 130px"
            />
            <button
              id="applyChurnFilter"
              class="btn btn-primary btn-sm"
              style="font-size: 0.75rem; padding: 0.25rem 0.5rem"
            >
              Apply
            </button>
          </div>
        </div>

        <div class="row text-center">
          <div class="col-4">
            <div class="p-2">
              <h5 id="churnRate" class="text-danger mb-1">-</h5>
              <small class="text-muted">Churn Rate</small>
            </div>
          </div>
          <div class="col-4">
            <div class="p-2">
              <h5 id="churnedCount" class="text-warning mb-1">-</h5>
              <small class="text-muted">Churned Users</small>
            </div>
          </div>
          <div class="col-4">
            <div class="p-2">
              <h5 id="activeCount" class="text-success mb-1">-</h5>
              <small class="text-muted">Active Users</small>
            </div>
          </div>
        </div>

        <div class="">
          <div class="card">
            <div class="card-header py-2">
              <h6 class="mb-0">Churn Trend</h6>
            </div>
            <div class="card-body p-2" style="height: 240px">
              <canvas id="churnTrendChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-lg-6">
      <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center">
          <h5><i class="fas fa-money-bill-wave me-2"></i>Revenue by Product</h5>
          <div class="d-flex gap-2">
            <select
              id="revenueProductFilter"
              class="form-select form-select-sm"
              style="width: 120px"
            >
              <option value="all">All Products</option>
            </select>
          </div>
        </div>
        <canvas id="revenueChart"></canvas>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
        </div>
        <div class="card-body p-3">
          <a
            href="{% url 'bulkrep:bulk_report' %}"
            class="btn btn-primary btn-sm me-2"
          >
            <i class="fas fa-file-alt me-1"></i> Generate Bulk Report
          </a>
          <a
            href="{% url 'bulkrep:single_report' %}"
            class="btn btn-secondary btn-sm me-2"
          >
            <i class="fas fa-file me-1"></i> Generate Single Report
          </a>
          <a href="{% url 'admin:index' %}" class="btn btn-info btn-sm">
            <i class="fas fa-cog me-1"></i> Admin Panel
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  class DashboardManager {
    constructor() {
      this.charts = {};
      this.isDataLoaded = false;
      this.init();
    }

    init() {
      this.initializeDateInputs();
      this.setupEventListeners();
      this.manageButtonStates();
      this.showPlaceholderContent();
      // Auto-refresh every 24 hours (daily) - only if data is loaded
      setInterval(() => {
        if (this.isDataLoaded) {
          this.loadData();
        }
      }, 86400000);
    }

    setupEventListeners() {
      document
        .getElementById("datePreset")
        .addEventListener("change", () => this.handleDatePresetChange());
      document
        .getElementById("startDate")
        .addEventListener("change", () => this.handleCustomDateChange());
      document
        .getElementById("endDate")
        .addEventListener("change", () => this.handleCustomDateChange());
      document
        .getElementById("loadDashboardBtn")
        .addEventListener("click", () => this.loadDashboardData());
      document
        .getElementById("applyBtn")
        .addEventListener("click", () => this.applyDateChanges());
      document
        .getElementById("refreshBtn")
        .addEventListener("click", () => this.loadData());

      // Individual chart filter listeners
      document
        .getElementById("usageTrendsTimeFilter")
        .addEventListener("change", () => this.updateUsageTrendsChart());
      document
        .getElementById("topProductsFilter")
        .addEventListener("change", () => this.updateTopProductsChart());
      document
        .getElementById("topSubscribersFilter")
        .addEventListener("change", () => this.updateTopSubscribersChart());
      document
        .getElementById("revenueProductFilter")
        .addEventListener("change", () => this.updateRevenueChart());
      document
        .getElementById("newSubscribersTimeFilter")
        .addEventListener("change", () => this.updateNewSubscribersChart());
      document
        .getElementById("applyChurnFilter")
        .addEventListener("click", () => this.updateChurnAnalysis());
      document
        .getElementById("churnStartDate")
        .addEventListener("change", () => this.validateChurnDateRange());
      document
        .getElementById("churnEndDate")
        .addEventListener("change", () => this.validateChurnDateRange());
      document
        .getElementById("downloadChurnedBtn")
        .addEventListener("click", () => this.downloadChurnedSubscribers());
      document
        .getElementById("downloadNewSubscribersBtn")
        .addEventListener("click", () => this.downloadNewSubscribers());
      document
        .getElementById("applyNewSubscribersDateRange")
        .addEventListener("click", () => this.applyNewSubscribersDateRange());
      document
        .getElementById("newSubscribersStartDate")
        .addEventListener("change", () => this.validateNewSubscribersDateRange());
      document
        .getElementById("newSubscribersEndDate")
        .addEventListener("change", () => this.validateNewSubscribersDateRange());

      // Global filter listeners
      document
        .getElementById("globalSubscriberFilter")
        .addEventListener("change", () => {
          // Update placeholder to show selected subscriber (without applying filter)
          const selectedValue = document.getElementById(
            "globalSubscriberFilter"
          ).value;
          this.updateSubscriberFilterPlaceholder(selectedValue);
        });
      
      // Add keyboard support for Enter key on dropdown
      document
        .getElementById("globalSubscriberFilter")
        .addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            this.applyGlobalFilters();
          }
        });
      
      // Apply filter button listener
      document
        .getElementById("applySubscriberFilterBtn")
        .addEventListener("click", () => {
          this.applyGlobalFilters();
        });
      
      document
        .getElementById("resetFiltersBtn")
        .addEventListener("click", () => this.resetGlobalFilters());
    }

    showLoading() {
      const loadingOverlay = document.getElementById("loadingOverlay");
      loadingOverlay.style.display = ""; // Clear any inline styles
      loadingOverlay.classList.remove("hidden");
    }

    hideLoading() {
      const loadingOverlay = document.getElementById("loadingOverlay");
      loadingOverlay.style.display = ""; // Clear any inline styles
      loadingOverlay.classList.add("hidden");
    }

    async loadData() {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;

      // Get global filter values
      const subscriberFilter =
        document.getElementById("globalSubscriberFilter")?.value || "all";

      this.showLoading();

      try {
        // Build query parameters
        const params = new URLSearchParams();

        if (startDate) {
          params.append("start_date", startDate);
        }
        if (endDate) {
          params.append("end_date", endDate);
        }

        // Add filter parameters if they're not 'all'
        if (subscriberFilter !== "all") {
          params.append("subscriber_filter", subscriberFilter);
        }

        const response = await fetch(`/dashboard-api/?${params.toString()}`, {
          credentials: 'same-origin'
        });

        if (!response.ok) {
          // Handle specific HTTP status codes
          if (response.status === 401) {
            throw new Error('Authentication required. Please log in.');
          } else if (response.status === 403) {
            throw new Error('Insufficient permissions to access dashboard data.');
          } else {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
        }

        // Check if response is actually JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('Server returned non-JSON response. Please check your authentication status.');
        }

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        // Validate data structure
        if (!data || typeof data !== "object") {
          throw new Error("Invalid data format received from server");
        }

        // Provide default values for missing data
        const safeData = {
          total_subscribers: data.total_subscribers || 0,
          total_usage_entries: data.total_usage_entries || 0,
          top_subscribers: Array.isArray(data.top_subscribers)
            ? data.top_subscribers
            : [],
          top_products: Array.isArray(data.top_products)
            ? data.top_products
            : [],
          revenue_data: Array.isArray(data.revenue_data)
            ? data.revenue_data
            : [],
          usage_trends: Array.isArray(data.usage_trends)
            ? data.usage_trends
            : [],
          new_subscribers: Array.isArray(data.new_subscribers)
            ? data.new_subscribers
            : [],
          churn_data: data.churn_data || {
            churn_rate: 0,
            churned_count: 0,
            current_subscribers: 0,
          },
          retention_rate: data.retention_rate || { retention_rate: 0 },
          highest_product_by_transaction:
            data.highest_product_by_transaction || "N/A",
          highest_product_by_revenue: data.highest_product_by_revenue || "N/A",
          unique_products: Array.isArray(data.unique_products)
            ? data.unique_products
            : [],
          unique_subscribers: Array.isArray(data.unique_subscribers)
            ? data.unique_subscribers
            : [],
          daily_comparison: data.daily_comparison || null,
        };

        this.updateMetrics(safeData);
        this.updateCharts(safeData);
        this.updateLastUpdated();
        this.isDataLoaded = true;
        this.manageButtonStates();
      } catch (error) {
        console.error("Error loading dashboard data:", error);

        // Show user-friendly error message
        const errorMessage = error.message.includes("fetch")
          ? "Network error. Please check your connection and try again."
          : `Error loading dashboard data: ${error.message}`;

        // Update UI to show error state instead of breaking
        const elements = [
          "totalSubscribers", "totalUsage", "totalRevenue", "topSubscriber",
          "highestProductByTransaction", "highestProductByRevenue"
        ];
        
        elements.forEach(elementId => {
          const element = document.getElementById(elementId);
          if (element) {
            element.textContent = "Error";
          }
        });

        alert(errorMessage);
      } finally {
        this.hideLoading();
      }
    }

    updateMetrics(data) {
      // Add null checks to prevent TypeError
      const totalSubscribersEl = document.getElementById("totalSubscribers");
      if (totalSubscribersEl) {
        totalSubscribersEl.textContent = data.total_subscribers.toLocaleString();
      }
      
      const totalUsageEl = document.getElementById("totalUsage");
      if (totalUsageEl) {
        totalUsageEl.textContent = data.total_usage_entries.toLocaleString();
      }

      // Calculate base revenue
      const baseRevenue =
        data.revenue_data && data.revenue_data.length > 0
          ? data.revenue_data.reduce((sum, item) => sum + item.revenue, 0)
          : 0;

      // Add 7.50% VAT to get total revenue
      const vatRate = 0.075; // 7.50%
      const vatAmount = baseRevenue * vatRate;
      const totalRevenue = baseRevenue + vatAmount;

      const totalRevenueEl = document.getElementById("totalRevenue");
      if (totalRevenueEl) {
        totalRevenueEl.textContent = `â‚¦${totalRevenue.toLocaleString()}`;
      }

      // Update top subscriber
      const topSubscriber =
        data.top_subscribers && data.top_subscribers.length > 0
          ? data.top_subscribers[0].SubscriberName
          : "N/A";
      const topSubscriberEl = document.getElementById("topSubscriber");
      if (topSubscriberEl) {
        topSubscriberEl.textContent =
          topSubscriber.length > 15
            ? topSubscriber.substring(0, 15) + "..."
            : topSubscriber;
      }

      const retentionRateEl = document.getElementById("retentionRate");
      if (retentionRateEl) {
        retentionRateEl.textContent = `${data.retention_rate.retention_rate}%`;
      }

      // Update highest product by transaction
      const highestProductByTransaction =
        data.highest_product_by_transaction || "N/A";
      const highestProductByTransactionEl = document.getElementById("highestProductByTransaction");
      if (highestProductByTransactionEl) {
        highestProductByTransactionEl.textContent =
          highestProductByTransaction.length > 15
            ? highestProductByTransaction.substring(0, 15) + "..."
            : highestProductByTransaction;
      }

      // Update highest product by revenue
      const highestProductByRevenue = data.highest_product_by_revenue || "N/A";
      const highestProductByRevenueEl = document.getElementById("highestProductByRevenue");
      if (highestProductByRevenueEl) {
        highestProductByRevenueEl.textContent =
          highestProductByRevenue.length > 15
            ? highestProductByRevenue.substring(0, 15) + "..."
            : highestProductByRevenue;
      }

      // Update churn metrics
      const churnRateEl = document.getElementById("churnRate");
      if (churnRateEl) {
        churnRateEl.textContent = `${data.churn_data.churn_rate}%`;
      }
      
      const churnedCountEl = document.getElementById("churnedCount");
      if (churnedCountEl) {
        churnedCountEl.textContent = data.churn_data.churned_count.toLocaleString();
      }
      
      const activeCountEl = document.getElementById("activeCount");
      if (activeCountEl) {
        activeCountEl.textContent = data.churn_data.current_subscribers.toLocaleString();
      }

      // Populate filter dropdowns
      this.populateFilterDropdowns(data);
      this.populateGlobalFilters(data);

     // --- NEW: Daily Comparison Metric ---
// --- CORRECTED AND COMPLETE Daily Comparison Metric Logic ---
      const yesterdayUsageEl = document.getElementById("yesterdayUsage");
      const prevMonthSameDayUsageEl = document.getElementById("prevMonthSameDayUsage");
      const dailyComparisonLabelEl = document.getElementById("dailyComparisonLabel");
      
      console.log('Daily comparison data:', data.daily_comparison);
      console.log('Yesterday element:', yesterdayUsageEl);
      console.log('Prev month element:', prevMonthSameDayUsageEl);
      
      if (data.daily_comparison) {
        console.log('Processing daily comparison data');
        if (yesterdayUsageEl) {
          const yesterdayCount = data.daily_comparison.yesterday.count;
          console.log('Setting yesterday count to:', yesterdayCount);
          yesterdayUsageEl.textContent = yesterdayCount.toLocaleString();
        }
        if (prevMonthSameDayUsageEl) {
          const prevMonthCount = data.daily_comparison.previous_month_same_day.count;
          console.log('Setting prev month count to:', prevMonthCount);
          prevMonthSameDayUsageEl.textContent = prevMonthCount.toLocaleString();
        }
        if (dailyComparisonLabelEl) {
          const yesterdayDate = new Date(data.daily_comparison.yesterday.date + 'T00:00:00');
          const prevMonthDate = new Date(data.daily_comparison.previous_month_same_day.date + 'T00:00:00');
          dailyComparisonLabelEl.textContent = `Usage: ${yesterdayDate.toLocaleDateString()} vs ${prevMonthDate.toLocaleDateString()}`;
        }
      } else {
        console.log('No daily comparison data found');
        if (yesterdayUsageEl) {
          yesterdayUsageEl.textContent = "-";
        }
        if (prevMonthSameDayUsageEl) {
          prevMonthSameDayUsageEl.textContent = "-";
        }
        if (dailyComparisonLabelEl) {
          dailyComparisonLabelEl.textContent = "Yesterday's Usage vs. Same Day Last Month";
        }
      }
    }

    updateLastUpdated() {
      const now = new Date();
      const lastUpdatedEl = document.getElementById("lastUpdated");
      if (lastUpdatedEl) {
        lastUpdatedEl.textContent = now.toLocaleTimeString();
      }
    }

    updateCharts(data) {
      this.dashboardData = data; // Store data for filtering
      this.createUsageTrendsChart(data.usage_trends);
      this.createTopProductsChart(data.top_products);
      this.createTopSubscribersChart(data.top_subscribers);
      this.createRevenueChart(data.revenue_data);
      this.createNewSubscribersChart(data.new_subscribers);

      // 3-month chart will be loaded on demand when button is clicked
    }

    populateFilterDropdowns(data) {
      // Populate product filters
      const productFilter = document.getElementById("topProductsFilter");
      const revenueProductFilter = document.getElementById(
        "revenueProductFilter"
      );

      // Clear existing options except 'All'
      productFilter.innerHTML = '<option value="all">All Products</option>';
      revenueProductFilter.innerHTML =
        '<option value="all">All Products</option>';

      // Add product options with error checking
      let products = [];
      if (
        data.top_products &&
        Array.isArray(data.top_products) &&
        data.top_products.length > 0
      ) {
        try {
          products = [
            ...new Set(
              data.top_products.map((item) => {
                // Handle different possible field names
                return (
                  item.ProductName ||
                  item.product ||
                  item.name ||
                  "Unknown Product"
                );
              })
            ),
          ];
        } catch (error) {
          console.error(
            "Error processing top_products data:",
            error,
            data.top_products
          );
          products = [];
        }
      }

      products.forEach((product) => {
        if (product && product !== "Unknown Product") {
          const option1 = new Option(
            product.length > 20 ? product.substring(0, 20) + "..." : product,
            product
          );
          const option2 = new Option(
            product.length > 20 ? product.substring(0, 20) + "..." : product,
            product
          );
          productFilter.appendChild(option1);
          revenueProductFilter.appendChild(option2);
        }
      });

      // Populate subscriber filter
      const subscriberFilter = document.getElementById("topSubscribersFilter");
      subscriberFilter.innerHTML =
        '<option value="all">All Subscribers</option>';

      let subscribers = [];
      if (
        data.top_subscribers &&
        Array.isArray(data.top_subscribers) &&
        data.top_subscribers.length > 0
      ) {
        try {
          subscribers = [
            ...new Set(
              data.top_subscribers.map((item) => {
                // Handle different possible field names
                return (
                  item.SubscriberName ||
                  item.subscriber ||
                  item.name ||
                  "Unknown Subscriber"
                );
              })
            ),
          ];
        } catch (error) {
          console.error(
            "Error processing top_subscribers data:",
            error,
            data.top_subscribers
          );
          subscribers = [];
        }
      }
      subscribers.forEach((subscriber) => {
        if (subscriber && subscriber !== "Unknown Subscriber") {
          const option = new Option(
            subscriber.length > 25
              ? subscriber.substring(0, 25) + "..."
              : subscriber,
            subscriber
          );
          subscriberFilter.appendChild(option);
        }
      });
    }

    // Individual chart update methods
    updateUsageTrendsChart() {
      if (!this.dashboardData) return;
      this.showLoading();
      const days = parseInt(
        document.getElementById("usageTrendsTimeFilter").value
      );
      const filteredData = this.dashboardData.usage_trends.slice(-days);
      this.createUsageTrendsChart(filteredData);
      this.hideLoading();
    }

    updateTopProductsChart() {
      if (!this.dashboardData) return;
      this.showLoading();
      const selectedProduct =
        document.getElementById("topProductsFilter").value;
      let filteredData = this.dashboardData.top_products;

      if (selectedProduct !== "all") {
        filteredData = filteredData.filter(
          (item) => item.ProductName === selectedProduct
        );
      }

      this.createTopProductsChart(filteredData);
      this.hideLoading();
    }

    updateTopSubscribersChart() {
      if (!this.dashboardData) return;
      this.showLoading();
      const selectedSubscriber = document.getElementById(
        "topSubscribersFilter"
      ).value;
      let filteredData = this.dashboardData.top_subscribers;

      if (selectedSubscriber !== "all") {
        filteredData = filteredData.filter(
          (item) => item.SubscriberName === selectedSubscriber
        );
      }

      this.createTopSubscribersChart(filteredData);
      this.hideLoading();
    }

    updateRevenueChart() {
      if (!this.dashboardData) return;
      this.showLoading();
      const selectedProduct = document.getElementById(
        "revenueProductFilter"
      ).value;
      let filteredData = this.dashboardData.revenue_data;

      if (selectedProduct !== "all") {
        filteredData = filteredData.filter(
          (item) => item.product === selectedProduct
        );
      }

      this.createRevenueChart(filteredData);
      this.hideLoading();
    }

    updateNewSubscribersChart() {
      if (!this.dashboardData) return;
      this.showLoading();
      
      const filterValue = document.getElementById("newSubscribersTimeFilter").value;
      
      if (filterValue === "custom") {
        // Show custom date range controls
        document.getElementById("newSubscribersDateRange").style.display = "block";
        this.hideLoading();
        return;
      } else {
        // Hide custom date range controls and applied date range display
        document.getElementById("newSubscribersDateRange").style.display = "none";
        document.getElementById("appliedNewSubscribersDateRange").style.display = "none";
        
        const days = parseInt(filterValue);
        const filteredData = this.dashboardData.new_subscribers.slice(-days);
        this.createNewSubscribersChart(filteredData);
      }
      
      this.hideLoading();
    }

    updateChurnAnalysis() {
      // Get date range values
      const startDate = document.getElementById("churnStartDate").value;
      const endDate = document.getElementById("churnEndDate").value;

      if (!startDate || !endDate) {
        alert("Please select both start and end dates for churn analysis.");
        return;
      }

      if (new Date(startDate) > new Date(endDate)) {
        alert("Start date cannot be later than end date.");
        return;
      }

      this.showLoading();

      // Make API call to get churn data for the selected date range
      const params = new URLSearchParams({
        start_date: startDate,
        end_date: endDate,
        churn_analysis: "true",
      });

      fetch(`/dashboard-api/?${params.toString()}`, {
        credentials: 'same-origin'
      })
        .then((response) => {
          if (!response.ok) {
            if (response.status === 401) {
              throw new Error('Authentication required. Please log in.');
            } else if (response.status === 403) {
              throw new Error('Insufficient permissions to access data.');
            } else {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
          }
          
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned non-JSON response. Please check your authentication status.');
          }
          
          return response.json();
        })
        .then((data) => {
          if (data.churn_data) {
            this.updateChurnDisplay(data.churn_data);
          }
          this.hideLoading();
        })
        .catch((error) => {
          console.error("Error fetching churn data:", error);
          this.hideLoading();
        });
    }

    downloadChurnedSubscribers() {
      // Get churn analysis date range values
      const startDate = document.getElementById("churnStartDate").value;
      const endDate = document.getElementById("churnEndDate").value;

      if (!startDate || !endDate) {
        alert("Please select both start and end dates before downloading.");
        return;
      }

      // Build URL with parameters
      const params = new URLSearchParams();
      params.append("start_date", startDate);
      params.append("end_date", endDate);

      // Create download URL
      const downloadUrl = `/download-churned-subscribers/?${params.toString()}`;

      // Trigger download by creating a temporary link
      const link = document.createElement("a");
      link.href = downloadUrl;
      link.download = "";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    downloadNewSubscribers() {
      const filterValue = document.getElementById("newSubscribersTimeFilter").value;
      
      let startDate, endDate;
      
      if (filterValue === "custom") {
        // Get custom date range values
        startDate = document.getElementById("newSubscribersStartDate").value;
        endDate = document.getElementById("newSubscribersEndDate").value;
        
        if (!startDate || !endDate) {
          alert("Please select both start and end dates before downloading.");
          return;
        }
      } else {
        // Calculate date range based on selected days
        const days = parseInt(filterValue);
        const today = new Date();
        const startDateObj = new Date(today);
        startDateObj.setDate(today.getDate() - days);
        
        endDate = today.toISOString().split('T')[0];
        startDate = startDateObj.toISOString().split('T')[0];
      }
      
      // Build URL with parameters
      const params = new URLSearchParams();
      params.append("start_date", startDate);
      params.append("end_date", endDate);
      
      // Create download URL
      const downloadUrl = `/download-new-subscribers/?${params.toString()}`;
      
      // Trigger download by creating a temporary link
      const link = document.createElement("a");
      link.href = downloadUrl;
      link.download = "";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    applyNewSubscribersDateRange() {
      const startDate = document.getElementById("newSubscribersStartDate").value;
      const endDate = document.getElementById("newSubscribersEndDate").value;
      
      if (!startDate || !endDate) {
        alert("Please select both start and end dates.");
        return;
      }
      
      if (new Date(startDate) > new Date(endDate)) {
        alert("Start date cannot be later than end date.");
        return;
      }
      
      this.showLoading();
      
      // Fetch new subscribers data for custom date range
      fetch(`/api/new-subscribers-trend/?start_date=${startDate}&end_date=${endDate}`, {
        credentials: 'same-origin'
      })
        .then(response => {
          if (!response.ok) {
            if (response.status === 401) {
              throw new Error('Authentication required. Please log in.');
            } else if (response.status === 403) {
              throw new Error('Insufficient permissions to access data.');
            } else {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
          }
          
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned non-JSON response. Please check your authentication status.');
          }
          
          return response.json();
        })
        .then(data => {
          this.createNewSubscribersChart(data.new_subscribers);
          
          // Show applied date range
          const formattedStartDate = new Date(startDate).toLocaleDateString();
          const formattedEndDate = new Date(endDate).toLocaleDateString();
          document.getElementById('appliedDateRangeText').textContent = `${formattedStartDate} - ${formattedEndDate}`;
          document.getElementById('appliedNewSubscribersDateRange').style.display = 'block';
          
          this.hideLoading();
        })
        .catch(error => {
          console.error('Error fetching new subscribers data:', error);
          alert('Error fetching data. Please try again.');
          this.hideLoading();
        });
    }

    validateNewSubscribersDateRange() {
      const startDate = document.getElementById("newSubscribersStartDate").value;
      const endDate = document.getElementById("newSubscribersEndDate").value;
      
      if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
        alert("Start date cannot be later than end date.");
        document.getElementById("newSubscribersStartDate").value = "";
        document.getElementById("newSubscribersEndDate").value = "";
      }
    }

    updateChurnDisplay(churnData) {
      // Update churn rate
      const churnRateElement = document.getElementById("churnRate");
      if (churnData.churn_rate !== undefined) {
        churnRateElement.textContent = `${churnData.churn_rate.toFixed(1)}%`;
      } else {
        churnRateElement.textContent = "-";
      }

      // Update churned count
      const churnedCountElement = document.getElementById("churnedCount");
      if (churnData.churned_count !== undefined) {
        churnedCountElement.textContent =
          churnData.churned_count.toLocaleString();
      } else {
        churnedCountElement.textContent = "-";
      }

      // Update active count
      const activeCountElement = document.getElementById("activeCount");
      if (churnData.current_subscribers !== undefined) {
        activeCountElement.textContent =
          churnData.current_subscribers.toLocaleString();
      } else {
        activeCountElement.textContent = "-";
      }

      // Create churn trend chart if trend data is available
      if (churnData.trend_data && churnData.trend_data.length > 0) {
        this.createChurnTrendChart(churnData.trend_data);
      }
    }

    validateChurnDateRange() {
      const startDate = document.getElementById("churnStartDate").value;
      const endDate = document.getElementById("churnEndDate").value;
      const applyButton = document.getElementById("applyChurnFilter");

      if (startDate && endDate) {
        if (new Date(startDate) > new Date(endDate)) {
          applyButton.disabled = true;
          applyButton.title = "Start date cannot be later than end date";
        } else {
          applyButton.disabled = false;
          applyButton.title = "Apply date filter for churn analysis";
        }
      } else {
        applyButton.disabled = !startDate || !endDate;
        applyButton.title =
          startDate && endDate
            ? "Apply date filter for churn analysis"
            : "Please select both start and end dates";
      }
    }

    populateGlobalFilters(data) {
      // Populate global subscriber filter
      const globalSubscriberFilter = document.getElementById(
        "globalSubscriberFilter"
      );

      // Store current selection to maintain it
      const currentSelection = globalSubscriberFilter.value;

      globalSubscriberFilter.innerHTML =
        '<option value="all">All Subscribers</option>';

      // Use unique_subscribers when available, fallback to top_subscribers for subscriber filtering
      let allSubscribers = [];
      if (data.unique_subscribers && Array.isArray(data.unique_subscribers)) {
        allSubscribers = data.unique_subscribers;
      } else if (data.top_subscribers && Array.isArray(data.top_subscribers)) {
        // Fallback for when subscriber filtering is active and unique_subscribers is not provided
        allSubscribers = data.top_subscribers.map(item => 
          item.SubscriberName || item.subscriber || item.name
        ).filter(Boolean);
      }
      
      allSubscribers.forEach((subscriber) => {
        // Add null check to prevent TypeError
        if (subscriber && typeof subscriber === "string") {
          const option = new Option(
            subscriber.length > 30
              ? subscriber.substring(0, 30) + "..."
              : subscriber,
            subscriber
          );
          globalSubscriberFilter.appendChild(option);
        }
      });

      // Restore previous selection if it still exists
      if (currentSelection && currentSelection !== "all") {
        const optionExists = Array.from(globalSubscriberFilter.options).some(
          (option) => option.value === currentSelection
        );
        if (optionExists) {
          globalSubscriberFilter.value = currentSelection;
          // Update placeholder to show selected subscriber
          this.updateSubscriberFilterPlaceholder(currentSelection);
        }
      }
    }

    updateSubscriberFilterPlaceholder(selectedValue) {
      const globalSubscriberFilter = document.getElementById(
        "globalSubscriberFilter"
      );
      const allOption = globalSubscriberFilter.querySelector(
        'option[value="all"]'
      );

      if (selectedValue && selectedValue !== "all") {
        // Find the selected option to get its display text
        const selectedOption = globalSubscriberFilter.querySelector(
          `option[value="${selectedValue}"]`
        );
        if (selectedOption) {
          allOption.textContent = selectedOption.textContent;
        }
      } else {
        allOption.textContent = "All Subscribers";
      }
    }

    applyGlobalFilters() {
      // This function now triggers a new API call with the selected filters.
      // The backend will handle the filtering and caching, ensuring correct data is displayed.
      this.loadData();
    }

    resetGlobalFilters() {
      document.getElementById("globalSubscriberFilter").value = "all";
      // Update placeholder to default
      this.updateSubscriberFilterPlaceholder("all");
      
      // Reload data from the backend with no filters applied.
      this.loadData();
    }

    createUsageTrendsChart(data) {
      const ctx = document.getElementById("usageTrendsChart").getContext("2d");
      if (this.charts.usageTrends) this.charts.usageTrends.destroy();

      this.charts.usageTrends = new Chart(ctx, {
        type: "line",
        data: {
          labels: data.map((item) => {
            const date = new Date(item.date);
            return `${date.getDate()}/${(date.getMonth() + 1)
              .toString()
              .padStart(2, "0")}/${date.getFullYear()}`;
          }),
          datasets: [
            {
              label: "Daily Usage",
              data: data.map((item) => item.count),
              borderColor: "#667eea",
              backgroundColor: "rgba(102, 126, 234, 0.1)",
              tension: 0.4,
              fill: true,
              pointBackgroundColor: "#667eea",
              pointBorderColor: "#fff",
              pointBorderWidth: 2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: "rgba(0,0,0,0.1)",
              },
            },
            x: {
              grid: {
                color: "rgba(0,0,0,0.1)",
              },
              ticks: {
                maxRotation: 45,
                minRotation: 0,
                padding: 10,
                font: {
                  size: 11,
                },
              },
            },
          },
        },
      });
    }

    createTopProductsChart(data) {
      const ctx = document.getElementById("topProductsChart").getContext("2d");
      if (this.charts.topProducts) this.charts.topProducts.destroy();

      // Handle empty or invalid data
      if (!data || !Array.isArray(data) || data.length === 0) {
        this.charts.topProducts = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["No Data"],
            datasets: [
              {
                data: [1],
                backgroundColor: ["#E0E0E0"],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false },
            },
          },
        });
        return;
      }

      const colors = [
        "#FF6384",
        "#36A2EB",
        "#FFCE56",
        "#4BC0C0",
        "#9966FF",
        "#FF9F40",
        "#FF6384",
        "#C9CBCF",
        "#4BC0C0",
        "#FF6384",
      ];

      this.charts.topProducts = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: data.map((item) => {
            const productName =
              item.ProductName || item.product || item.name || "Unknown";
            return productName.length > 15
              ? productName.substring(0, 15) + "..."
              : productName;
          }),
          datasets: [
            {
              data: data.map(
                (item) => item.frequency || item.count || item.usage_count || 0
              ),
              backgroundColor: colors,
              borderWidth: 2,
              borderColor: "#fff",
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "bottom",
              labels: {
                padding: 20,
                usePointStyle: true,
              },
            },
          },
        },
      });
    }

    createTopSubscribersChart(data) {
      const ctx = document
        .getElementById("topSubscribersChart")
        .getContext("2d");
      if (this.charts.topSubscribers) this.charts.topSubscribers.destroy();

      // Handle empty or invalid data
      if (!data || !Array.isArray(data) || data.length === 0) {
        this.charts.topSubscribers = new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["No Data"],
            datasets: [
              {
                label: "Usage Count",
                data: [0],
                backgroundColor: ["#E0E0E0"],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false },
            },
            scales: {
              y: { beginAtZero: true },
              x: { display: false },
            },
          },
        });
        return;
      }

      this.charts.topSubscribers = new Chart(ctx, {
        type: "bar",
        data: {
          labels: data.map((item) => {
            const subscriberName =
              item.SubscriberName || item.subscriber || item.name || "Unknown";
            return subscriberName.length > 20
              ? subscriberName.substring(0, 20) + "..."
              : subscriberName;
          }),
          datasets: [
            {
              label: "Usage Count",
              data: data.map(
                (item) => item.usage_count || item.count || item.frequency || 0
              ),
              backgroundColor: "rgba(54, 162, 235, 0.8)",
              borderColor: "#36A2EB",
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: "rgba(0,0,0,0.1)",
              },
            },
            x: {
              grid: {
                display: false,
              },
              ticks: {
                maxRotation: 45,
                minRotation: 0,
                padding: 10,
                font: {
                  size: 11,
                },
              },
            },
          },
        },
      });
    }

    createRevenueChart(data) {
      const ctx = document.getElementById("revenueChart").getContext("2d");
      if (this.charts.revenue) this.charts.revenue.destroy();

      this.charts.revenue = new Chart(ctx, {
        type: "bar",
        data: {
          labels: data.map((item) =>
            item.product.length > 15
              ? item.product.substring(0, 15) + "..."
              : item.product
          ),
          datasets: [
            {
              label: "Revenue (â‚¦)",
              data: data.map((item) => item.revenue),
              backgroundColor: "rgba(75, 192, 192, 0.8)",
              borderColor: "#4BC0C0",
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: "rgba(0,0,0,0.1)",
              },
              ticks: {
                callback: function (value) {
                  return "â‚¦" + value.toLocaleString();
                },
              },
            },
            x: {
              grid: {
                display: false,
              },
              ticks: {
                maxRotation: 45,
                minRotation: 0,
                padding: 10,
                font: {
                  size: 11,
                },
              },
            },
          },
        },
      });
    }

    createNewSubscribersChart(data) {
      const ctx = document
        .getElementById("newSubscribersChart")
        .getContext("2d");
      if (this.charts.newSubscribers) this.charts.newSubscribers.destroy();

      this.charts.newSubscribers = new Chart(ctx, {
        type: "line",
        data: {
          labels: data.map((item) => {
            const date = new Date(item.date);
            return `${date.getDate()}/${(date.getMonth() + 1)
              .toString()
              .padStart(2, "0")}/${date.getFullYear()}`;
          }),
          datasets: [
            {
              label: "New Subscribers",
              data: data.map((item) => item.new_subscribers),
              borderColor: "#9966FF",
              backgroundColor: "rgba(153, 102, 255, 0.1)",
              tension: 0.4,
              fill: true,
              pointBackgroundColor: "#9966FF",
              pointBorderColor: "#fff",
              pointBorderWidth: 2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: "rgba(0,0,0,0.1)",
              },
            },
            x: {
              grid: {
                color: "rgba(0,0,0,0.1)",
              },
            },
          },
        },
      });
    }

    createChurnTrendChart(data) {
      const ctx = document.getElementById("churnTrendChart").getContext("2d");
      if (this.charts.churnTrend) this.charts.churnTrend.destroy();

      this.charts.churnTrend = new Chart(ctx, {
        type: "line",
        data: {
          labels: data.map((item) => new Date(item.date).toLocaleDateString()),
          datasets: [
            {
              label: "Churn Rate (%)",
              data: data.map((item) => item.churn_rate),
              borderColor: "#dc3545",
              backgroundColor: "rgba(220, 53, 69, 0.1)",
              tension: 0.4,
              fill: true,
              pointBackgroundColor: "#dc3545",
              pointBorderColor: "#fff",
              pointBorderWidth: 2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: "rgba(0,0,0,0.1)",
              },
              ticks: {
                callback: function (value) {
                  return value + "%";
                },
              },
            },
            x: {
              grid: {
                color: "rgba(0,0,0,0.1)",
              },
              ticks: {
                maxRotation: 45,
                minRotation: 0,
                padding: 10,
                font: {
                  size: 11,
                },
              },
            },
          },
        },
      });
    }

    handleDatePresetChange() {
      const preset = document.getElementById("datePreset").value;
      const startDateInput = document.getElementById("startDate");
      const endDateInput = document.getElementById("endDate");
      const customInputs = document.getElementById("customDateInputs");

      if (preset === "custom") {
        customInputs.style.display = "flex";
        this.enableApplyButton();
        return;
      }

      customInputs.style.display = "none";

      const today = new Date();
      let startDate, endDate;

      switch (preset) {
        case "alltime":
          startDate = null;
          endDate = null;
          break;
      }

      if (startDate) {
        startDateInput.value = startDate.toISOString().split("T")[0];
      } else {
        startDateInput.value = "";
      }

      if (endDate) {
        endDateInput.value = endDate.toISOString().split("T")[0];
      } else {
        endDateInput.value = "";
      }

      this.updateCurrentDateRangeDisplay();
      // For preset changes, apply immediately
      this.loadData();
      this.disableApplyButton();
    }

    handleCustomDateChange() {
      document.getElementById("datePreset").value = "custom";
      document.getElementById("customDateInputs").style.display = "flex";
      this.updateCurrentDateRangeDisplay();
      this.enableApplyButton();
    }

    applyDateChanges() {
      this.loadData();
      this.disableApplyButton();
    }

    enableApplyButton() {
      const applyBtn = document.getElementById("applyBtn");
      applyBtn.disabled = false;
      applyBtn.classList.remove("btn-outline-secondary");
      applyBtn.classList.add("btn-refresh");
    }

    disableApplyButton() {
      const applyBtn = document.getElementById("applyBtn");
      applyBtn.disabled = true;
      applyBtn.classList.remove("btn-refresh");
      applyBtn.classList.add("btn-outline-secondary");
    }

    updateCurrentDateRangeDisplay() {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      const preset = document.getElementById("datePreset").value;
      const display = document.getElementById("currentDateRange");

      if (preset === "alltime") {
        display.textContent = "All available data";
      } else if (startDate && endDate) {
        const start = new Date(startDate).toLocaleDateString();
        const end = new Date(endDate).toLocaleDateString();
        display.textContent = `${start} to ${end}`;
      } else if (startDate) {
        display.textContent = `From ${new Date(
          startDate
        ).toLocaleDateString()}`;
      } else if (endDate) {
        display.textContent = `Until ${new Date(endDate).toLocaleDateString()}`;
      } else {
        display.textContent = "No date range selected";
      }
    }

    initializeDateInputs() {
      // Set default to current month (1st to 1st of next month) - same as single report
      const today = new Date();
      const currentYear = today.getFullYear();
      const currentMonth = today.getMonth(); // 0-indexed

      // Start date: first day of the current month
      const startDateObj = new Date(currentYear, currentMonth, 1);

      // End date: first day of the next month
      // The Date constructor handles month overflow automatically (e.g., month 11 (Dec) + 1 = month 12 -> Jan of next year)
      const endDateObj = new Date(currentYear, currentMonth + 1, 1);

      // Helper function to format date as yyyy-MM-dd using local date components
      function formatDateToYYYYMMDD(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, "0"); // getMonth is 0-indexed, +1 for actual month number
        const day = date.getDate().toString().padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      const formattedStartDate = formatDateToYYYYMMDD(startDateObj);
      const formattedEndDate = formatDateToYYYYMMDD(endDateObj);

      console.log(
        "Setting dates (local):",
        formattedStartDate,
        "to",
        formattedEndDate
      );

      document.getElementById("startDate").value = formattedStartDate;
      document.getElementById("endDate").value = formattedEndDate;
      document.getElementById("datePreset").value = "custom";
      document.getElementById("customDateInputs").style.display = "flex";

      this.updateCurrentDateRangeDisplay();
    }

    // New method to handle Load Dashboard button click
    loadDashboardData() {
      this.loadData();
    }

    // Manage button states based on data loading status
    manageButtonStates() {
      const loadBtn = document.getElementById('loadDashboardBtn');
      const applyBtn = document.getElementById('applyBtn');
      const refreshBtn = document.getElementById('refreshBtn');
      
      if (this.isDataLoaded) {
        // Data is loaded - hide load button, show refresh button
        loadBtn.style.display = 'none';
        refreshBtn.style.display = 'inline-block';
        // Apply button remains functional regardless of data state
      } else {
        // Data not loaded - show load button, hide refresh button
        loadBtn.style.display = 'inline-block';
        refreshBtn.style.display = 'none';
        // Apply button remains functional regardless of data state
      }
    }

    // Show placeholder content when dashboard is not loaded
    showPlaceholderContent() {
      // Hide loading overlay first
      this.hideLoading();
      
      // Set all metrics to placeholder values
      const metricElements = [
        'totalSubscribers', 'totalUsage', 'totalRevenue', 'topSubscriber',
        'retentionRate', 'highestProductByTransaction', 'highestProductByRevenue',
        'yesterdayUsage', 'prevMonthSameDayUsage'
      ];
      
      metricElements.forEach(elementId => {
        const element = document.getElementById(elementId);
        if (element) {
          element.textContent = '-';
        }
      });
      
      // Set date range display
      const currentDateRange = document.getElementById('currentDateRange');
      if (currentDateRange) {
        currentDateRange.textContent = 'Click "Load Dashboard" to view data';
      }
      
      // Set last updated
      const lastUpdated = document.getElementById('lastUpdated');
      if (lastUpdated) {
        lastUpdated.textContent = 'Not loaded';
      }
    }
  }

  // Initialize dashboard when page loads
  document.addEventListener("DOMContentLoaded", () => {
    const dashboard = new DashboardManager();
    window.dashboard = dashboard; // Make dashboard globally accessible

    // Initialize churn analysis date inputs with default values (current month range)
    const today = new Date();

    // Set start date to 1st of current month
    const currentMonthStart = new Date(
      today.getFullYear(),
      today.getMonth(),
      1
    );

    // Set end date to 1st of next month
    const nextMonthStart = new Date(
      today.getFullYear(),
      today.getMonth() + 1,
      1
    );

    // Helper function to format date as yyyy-MM-dd
    function formatDateToYYYYMMDD(date) {
      const year = date.getFullYear();
      const month = (date.getMonth() + 1).toString().padStart(2, "0");
      const day = date.getDate().toString().padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    document.getElementById("churnStartDate").value =
      formatDateToYYYYMMDD(currentMonthStart);
    document.getElementById("churnEndDate").value =
      formatDateToYYYYMMDD(nextMonthStart);
  });

  // Global variables for 3-month view
  let threeMonthChart = null;

  // Refresh 3-month rolling usage data
  function refreshThreeMonthData() {
    dashboard.showLoading();

    // Get current subscriber filter
    const subscriberFilter = document.getElementById(
      "globalSubscriberFilter"
    ).value;

    // Build URL with 3-month view parameter
    let url = "/dashboard-api/?three_month_view=true";
    if (subscriberFilter && subscriberFilter !== "all") {
      url += `&subscriber_filter=${encodeURIComponent(subscriberFilter)}`;
    }

    console.log("Refreshing 3-month data from URL:", url);

    fetch(url, {
      credentials: 'same-origin'
    })
      .then((response) => {
        console.log("Response status:", response.status);
        return response.json();
      })
      .then((data) => {
        console.log("Received refreshed data:", data);
        if (data.three_month_usage) {
          console.log("3-month usage data:", data.three_month_usage);
          renderThreeMonthChart(data.three_month_usage);
        } else {
          console.log("No three_month_usage data in response");
          alert("No 3-month usage data available.");
        }
      })
      .catch((error) => {
        console.error("Error refreshing 3-month data:", error);
        alert("Error refreshing 3-month usage data. Please try again.");
      })
      .finally(() => {
        dashboard.hideLoading();
      });
  }

  // Load 3-month rolling usage data
  function loadThreeMonthData() {
    dashboard.showLoading();

    // Get current subscriber filter
    const subscriberFilter = document.getElementById(
      "globalSubscriberFilter"
    ).value;

    // Build URL with 3-month view parameter
    let url = "/dashboard-api/?three_month_view=true";
    if (subscriberFilter && subscriberFilter !== "all") {
      url += `&subscriber_filter=${encodeURIComponent(subscriberFilter)}`;
    }

    console.log("Loading 3-month data from URL:", url);

    fetch(url, {
      credentials: 'same-origin'
    })
      .then((response) => {
        console.log("Response status:", response.status);
        return response.json();
      })
      .then((data) => {
        console.log("Received data:", data);
        if (data.three_month_usage) {
          console.log("3-month usage data:", data.three_month_usage);
          // Hide placeholder and show chart container
          document.getElementById("threeMonthPlaceholder").style.display =
            "none";
          document.getElementById("threeMonthChartContainer").style.display =
            "block";
          // Hide the load button and show refresh button after successful load
          document.getElementById("load3MonthBtn").style.display = "none";
          document.getElementById("refresh3MonthBtn").style.display = "block";
          renderThreeMonthChart(data.three_month_usage);
        } else {
          console.log("No three_month_usage data in response");
          alert("No 3-month usage data available.");
        }
      })
      .catch((error) => {
        console.error("Error loading 3-month data:", error);
        alert("Error loading 3-month usage data. Please try again.");
      })
      .finally(() => {
        dashboard.hideLoading();
      });
  }

  // Render 3-month usage chart
  function renderThreeMonthChart(data) {
    const ctx = document
      .getElementById("threeMonthUsageChart")
      .getContext("2d");

    // Destroy existing chart if it exists
    if (threeMonthChart) {
      threeMonthChart.destroy();
    }

    const labels = data.map((item) => item.month_short + " " + item.year);
    const usageCounts = data.map((item) => item.usage_count);

    threeMonthChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [
          {
            label: "Usage Entries",
            data: usageCounts,
            backgroundColor: [
              "rgba(54, 162, 235, 0.8)",
              "rgba(75, 192, 192, 0.8)",
              "rgba(255, 206, 86, 0.8)",
            ],
            borderColor: [
              "rgba(54, 162, 235, 1)",
              "rgba(75, 192, 192, 1)",
              "rgba(255, 206, 86, 1)",
            ],
            borderWidth: 2,
            borderRadius: 8,
            borderSkipped: false,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          },
          tooltip: {
            callbacks: {
              title: function (context) {
                const index = context[0].dataIndex;
                return data[index].month;
              },
              label: function (context) {
                return `Usage Entries: ${context.parsed.y.toLocaleString()}`;
              },
            },
          },
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function (value) {
                return value.toLocaleString();
              },
            },
            grid: {
              color: "rgba(0, 0, 0, 0.1)",
            },
          },
          x: {
            grid: {
              display: false,
            },
          },
        },
        animation: {
          duration: 1000,
          easing: "easeInOutQuart",
        },
      },
    });
  }
</script>
{% endblock %}